<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finalizar Pedido - Restaurante da C√©lia</title>
  <meta name="theme-color" content="#0a7d4f">
  <link rel="manifest" href="manifest.json">
  
  <style>
    :root{
      --bg:#fbfbfb; --card:#fff; --text:#151515; --muted:#666; --stroke:#e8e8e8;
      --brand:#0a7d4f; --accent:#e63946; --focus:#1c6ef2; --promo:#ffb703;
      --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.06); --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:18px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;padding-top:80px}
    
    .navbar{position:fixed;top:0;left:0;right:0;background:#fff;border-bottom:1px solid var(--stroke);z-index:100;padding:16px 20px}
    .navbar-content{max-width:1000px;margin:0 auto;display:flex;align-items:center;gap:16px}
    .back-btn{background:none;border:none;font-size:28px;cursor:pointer;padding:8px}
    .navbar h1{margin:0;font-size:22px;font-weight:600}
    
    .wrap{max-width:1000px;margin:0 auto;padding:24px clamp(20px,4vw,40px)}

    .btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;padding:12px 20px;border-radius:12px;border:1px solid var(--stroke);cursor:pointer;font-weight:700;background:#fff;text-decoration:none}
    .btn-primary{background:var(--brand);color:#fff;border:0}
    .btn:hover{transform:translateY(-1px)}

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:clamp(20px,3vw,32px);margin-bottom:20px}
    .card h2{margin:0 0 20px;font-size:24px;display:flex;align-items:center;gap:10px}

    fieldset{border:0;margin:0;padding:0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"],input[type="tel"],input[type="time"],input[type="number"],textarea,select{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--stroke);background:#fff;font-size:15px
    }
    input:focus,select:focus,textarea:focus{outline:3px solid color-mix(in oklab,var(--focus) 65%,transparent);outline-offset:2px}

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:560px){ .row{grid-template-columns:1fr 1fr} }

    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:20px}

    .cart-summary{background:#f8fffe;border:1px solid #d1fae5;border-radius:12px;padding:16px}
    .cart-item{padding:12px 0;border-bottom:1px dashed var(--stroke)}
    .cart-item:last-child{border-bottom:none}
    .cart-item h3{margin:0 0 4px;font-size:16px}
    .cart-mini{color:var(--muted);font-size:14px;line-height:1.4}
    .cart-total{font-size:18px;font-weight:700;color:var(--brand);text-align:right;margin-top:12px}

    .preview{width:100%;min-height:140px;white-space:pre-wrap;border:1px dashed var(--stroke);border-radius:12px;padding:12px;background:#fff;font-family:var(--mono);font-size:13px;line-height:1.4}

    .notice{margin-top:12px;padding:12px;border:1px dashed #ffd48a;background:#fff8e1;border-radius:12px;color:#634300}

    footer{color:var(--muted);font-size:12px;text-align:center;margin:24px 0 8px}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-content">
      <button class="back-btn" onclick="history.back()" aria-label="Voltar">‚Üê</button>
      <h1>üßæ Finalizar pedido</h1>
    </div>
  </nav>

  <div class="wrap">
    <!-- Resumo do carrinho -->
    <section class="card">
      <h2>üìã Resumo do pedido</h2>
      <div class="cart-summary" id="cart-summary">
        <div id="cart-items"></div>
        <div class="cart-total" id="cart-total">Total: R$ 0,00</div>
      </div>
    </section>

    <!-- Dados de entrega -->
    <section class="card">
      <h2>üìç Dados para entrega</h2>
      <div class="row">
        <div>
          <label for="nome">üôç Nome</label>
          <input id="nome" type="text" placeholder="Seu nome" required>
        </div>
        <div>
          <label for="telefone">üì± Telefone</label>
          <input id="telefone" type="tel" placeholder="(00) 00000-0000">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="endereco">üìç Endere√ßo</label>
          <input id="endereco" type="text" placeholder="Rua, n√∫mero, complemento" required>
        </div>
        <div>
          <label for="bairro">üèòÔ∏è Bairro</label>
          <input id="bairro" type="text" placeholder="Ex.: Centro">
        </div>
      </div>
      <div>
        <label for="referencia">üìå Ponto de refer√™ncia</label>
        <input id="referencia" type="text" placeholder="Ex.: Pr√≥ximo √† padaria Y">
      </div>
    </section>

    <!-- Dados do pedido -->
    <section class="card">
      <h2>‚è∞ Hor√°rio e pagamento</h2>
      <div class="row">
        <div>
          <label for="hora">‚è∞ Hor√°rio desejado</label>
          <input id="hora" type="time">
        </div>
        <div>
          <label for="pagamento">üí≥ Forma de pagamento</label>
          <select id="pagamento" required>
            <option value="">Selecione‚Ä¶</option>
            <option>PIX</option>
            <option>Dinheiro</option>
            <option>Cart√£o de d√©bito</option>
            <option>Cart√£o de cr√©dito</option>
          </select>
        </div>
      </div>

      <div id="troco-wrap" style="display:none;margin-top:12px">
        <label for="troco">üíµ Troco para (R$)</label>
        <input id="troco" type="number" step="1" inputmode="numeric" placeholder="Ex.: 100">
        <p style="margin:4px 0 0;color:var(--muted);font-size:13px">O sistema calcula o troco automaticamente.</p>
      </div>

      <div class="notice">
        <strong>Aten√ß√£o üöö:</strong> no momento da finaliza√ß√£o no WhatsApp, ser√° calculada a <u>taxa de entrega</u> conforme sua regi√£o.
      </div>
    </section>

    <!-- Pr√©via da mensagem -->
    <section class="card">
      <h2>üìÑ Pr√©via da mensagem</h2>
      <div id="preview" class="preview"></div>
      <div class="actions">
        <button class="btn" id="btn-copy">üìã Copiar mensagem</button>
        <button class="btn btn-primary" id="btn-wa">üí¨ Enviar pelo WhatsApp</button>
      </div>
    </section>

    <footer>
      <small>MARMITA.ONE ‚Ä¢ v1.0 ‚Ä¢ <a href="index.html" style="color:inherit">‚Üê Voltar ao in√≠cio</a></small>
    </footer>
  </div>

  <script src="shared.js"></script>
  <script>
    // Fun√ß√µes espec√≠ficas do checkout
    function renderCartSummary(){
      const itemsEl = byId("cart-items");
      const totalEl = byId("cart-total");
      
      if (CART.length === 0) {
        itemsEl.innerHTML = '<p style="text-align:center;color:var(--muted);margin:0">Carrinho vazio</p>';
        totalEl.textContent = "Total: R$ 0,00";
        return;
      }
      
      itemsEl.innerHTML = "";
      CART.forEach((entry, idx) => {
        const el = document.createElement("div");
        el.className = "cart-item";
        el.innerHTML = `
          <h3>Marmita #${idx + 1}</h3>
          <div class="cart-mini">${entry.mini}</div>
          <div style="margin-top:4px;font-weight:600">${fmt(entry.total)}</div>
        `;
        itemsEl.appendChild(el);
      });
      
      totalEl.textContent = `Total: ${fmt(cartTotal())}`;
    }

    function coletarCheckout(){
      const nome = byId("nome").value.trim();
      const telefone = byId("telefone").value.trim();
      const endereco = byId("endereco").value.trim();
      const bairro = byId("bairro").value.trim();
      const referencia = byId("referencia").value.trim();
      const hora = byId("hora").value;
      const pagamento = byId("pagamento").value;
      const trocoPara = byId("troco").value;
      
      let troco = null;
      if(pagamento === "Dinheiro" && trocoPara){
        const x = Number(String(trocoPara).replace(",","."));
        if(!isNaN(x)) troco = Math.max(0, x - cartTotal());
      }
      
      return { nome, telefone, endereco, bairro, referencia, hora, pagamento, trocoPara, troco };
    }

    function validarCheckout(d){
      const msgs = [];
      if(!CART.length) msgs.push("Adicione pelo menos 1 item ao carrinho.");
      if(!d.nome) msgs.push("Informe seu nome.");
      if(!d.endereco) msgs.push("Informe o endere√ßo para entrega.");
      if(!d.pagamento) msgs.push("Escolha a forma de pagamento.");
      return { ok: msgs.length===0, msgs };
    }

    function montarMensagem(){
      const d = coletarCheckout();
      const v = validarCheckout(d);
      if(!v.ok) return "";

      const linhas = [];
      linhas.push("üç± *Pedido de Marmitas*");
      linhas.push(`‚Ä¢ Restaurante da C√©lia`);
      linhas.push("");

      CART.forEach((e,idx)=>{
        const it = e.item;
        linhas.push(`Marmita #${idx+1}`);
        if(it.tamanho) linhas.push(`‚Ä¢ Tamanho: ${it.tamanho}`);
        if(it.proteina) linhas.push(`‚Ä¢ Prote√≠na: ${it.proteina}`);
        if(it.acompanhamentos?.length) linhas.push(`‚Ä¢ Acompanhamentos: ${it.acompanhamentos.join(', ')}`);
        if(it.adicionais2?.length) linhas.push(`‚Ä¢ Adicionais (+${fmt(CONFIG.regras.precoAdicional)}): ${it.adicionais2.join(', ')}`);
        if(it.carnes8?.length) linhas.push(`‚Ä¢ Carnes extras (+${fmt(CONFIG.regras.precoCarneExtra)}): ${it.carnes8.join(', ')}`);
        if(it.bebidas?.length) linhas.push(`‚Ä¢ Bebidas: ${it.bebidas.map(b=>`${b.nome}${b.preco?` (${fmt(b.preco)})`:''}`).join(', ')}`);
        if(it.obs) linhas.push(`‚Ä¢ Obs.: ${it.obs}`);
        linhas.push(`Valor: ${fmt(e.total)}`);
        linhas.push("");
      });

      linhas.push(`Total dos itens: *${fmt(cartTotal())}*`);
      linhas.push("Taxa de entrega ser√° calculada conforme a regi√£o.");
      linhas.push("");

      linhas.push(`üìç *Entrega:*`);
      if(d.nome) linhas.push(`‚Ä¢ Nome: ${d.nome}`);
      if(d.telefone) linhas.push(`‚Ä¢ Telefone: ${d.telefone}`);
      const enderecoFull = [d.endereco, d.bairro?`‚Äì ${d.bairro}`:"", d.referencia?`(Ref.: ${d.referencia})`:""].join(" ").replace(/\s+/g," ").trim();
      if(enderecoFull) linhas.push(`‚Ä¢ Endere√ßo: ${enderecoFull}`);
      if(d.hora) linhas.push(`‚Ä¢ Hor√°rio: ${d.hora}`);
      if(d.pagamento) linhas.push(`‚Ä¢ Pagamento: ${d.pagamento}`);
      
      if(d.pagamento === "PIX") {
        linhas.push(`‚Ä¢ Observa√ß√£o: Produ√ß√£o inicia ap√≥s envio do comprovante PIX.`);
      }
      
      if(d.pagamento === "Dinheiro" && d.troco !== null){
        linhas.push(`‚Ä¢ Troco para: ${fmt(Number(d.trocoPara))}`);
        linhas.push(`‚Ä¢ Enviar troco: ${fmt(d.troco)}`);
      }

      linhas.push("");
      linhas.push(`Pedidos at√© 14:30`);
      linhas.push("Obrigada! üôå");

      return linhas.join("\n").replace(/\n{3,}/g,"\n\n").trim();
    }

    function renderPreview(){ 
      const msg = montarMensagem();
      byId("preview").textContent = msg || "Preencha os dados acima para ver a pr√©via da mensagem"; 
    }

    function onPagamento(){ 
      const isDinheiro = byId("pagamento").value === "Dinheiro";
      byId("troco-wrap").style.display = isDinheiro ? "block" : "none"; 
      renderPreview(); 
    }

    async function copiarMensagem(){
      const msg = montarMensagem(); 
      if(!msg){ 
        alert("Preencha todos os campos obrigat√≥rios."); 
        return; 
      }
      
      try{ 
        await navigator.clipboard.writeText(msg); 
        alert("Mensagem copiada!"); 
      } catch {
        const ta=document.createElement("textarea"); 
        ta.value=msg; 
        document.body.appendChild(ta); 
        ta.select(); 
        document.execCommand("copy"); 
        document.body.removeChild(ta);
        alert("Mensagem copiada!");
      }
    }

    function abrirWhatsApp(){
      const msg = montarMensagem(); 
      if(!msg){ 
        alert("Preencha todos os campos obrigat√≥rios."); 
        return; 
      }
      
      const phone = "5531992034948"; // N√∫mero do WhatsApp
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }

    // Inicializar p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      loadCart();
      renderCartSummary();
      
      if (CART.length === 0) {
        alert("Seu carrinho est√° vazio! Adicione itens antes de finalizar o pedido.");
        window.location.href = "index.html";
        return;
      }
      
      // Event listeners
      document.getElementById("pagamento").addEventListener("change", onPagamento);
      document.getElementById("btn-copy").addEventListener("click", copiarMensagem);
      document.getElementById("btn-wa").addEventListener("click", abrirWhatsApp);
      
      // Atualizar pr√©via quando campos mudarem
      document.addEventListener("input", renderPreview);
      document.addEventListener("change", renderPreview);
      
      renderPreview();
    });
  </script>
</body>
</html>
