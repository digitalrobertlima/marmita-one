<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MARMITA.ONE v0.3.1 ‚Ä¢ Modo iPhone com Op√ß√µes + Aviso de Taxa</title>
    <meta name="format-detection" content="telephone=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1976d2">
    <link rel="icon" href="icons/icon-192x192.png" sizes="192x192">
  <style>
    :root{
      --bg:#fbfbfb; --card:#fff; --text:#151515; --muted:#666; --stroke:#e8e8e8;
      --brand:#0a7d4f; --accent:#e63946; --focus:#1c6ef2; --promo:#ffb703;
      --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.06); --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1024px;margin:0 auto;padding:18px clamp(14px,3vw,28px)}
    header{text-align:center;margin:6px 0 12px}
    header h1{margin:6px 0 4px;font-size:clamp(22px,6vw,34px)}
    header p{margin:0;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f6f6f6;border:1px solid var(--stroke);font-size:14px}
  /* Barra de compatibilidade agora no fim da p√°gina */
  .topbar{position:static;top:auto;z-index:10;background:#fff; border-top:1px solid var(--stroke); margin-top:16px}
    .topbar-inner{max-width:1024px;margin:0 auto;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 14px}
    .btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);cursor:pointer;font-weight:700;background:#fff}
    .btn-primary{background:var(--brand);color:#fff;border:0}
    .btn-ghost{border:1px dashed var(--stroke);color:#666}
    .btn-danger{background:#fff;color:var(--accent);border-color:#ffd5d8}
    .btn-promo{background:var(--promo);color:#402d00;border:0}

  /* Logo quadrada vermelha arredondada */
  .logo-square{width:40px;height:40px;border-radius:10px;background:#e10600;border:2px solid #b30000;box-shadow:0 2px 8px rgba(225,6,0,.15)}
  .brand-mark{display:flex;align-items:center;gap:10px;justify-content:center}

    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid{grid-template-columns: 2fr 1fr} }

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:clamp(14px,2.6vw,20px)}
    .card h2{margin:0 0 10px;font-size:18px;display:flex;align-items:center;gap:8px}
    .hint{color:var(--muted);font-size:13px}

    fieldset{border:0;margin:0;padding:0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"],input[type="tel"],input[type="time"],input[type="number"],textarea,select{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--stroke);background:#fff;font-size:15px
    }
    textarea{min-height:84px;resize:vertical}
    input:focus,select:focus,textarea:focus,button:focus{outline:3px solid color-mix(in oklab,var(--focus) 65%,transparent);outline-offset:2px}

    .list{display:grid;gap:8px}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;background:#fff}
    .price{color:var(--brand);font-weight:700}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--stroke);border-radius:999px;background:#fff;user-select:none}
    .chip input{accent-color:var(--brand)}
    .chip:has(input:checked){border-color:var(--brand)}

    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){ .row{grid-template-columns:1fr 1fr} }

    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}

    .cart{position:sticky;top:70px}
    .cart-list{display:grid;gap:8px;margin-top:8px}
    .cart-item{border:1px solid var(--stroke);border-radius:12px;padding:10px;background:#fff}
    .cart-item h3{margin:0 0 6px;font-size:15px}
    .cart-mini{color:#333;font-size:13px;white-space:pre-wrap}

    .total{display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:8px;border-top:1px dashed var(--stroke)}

    .preview{width:100%;min-height:140px;white-space:pre-wrap;border:1px dashed var(--stroke);border-radius:12px;padding:10px;background:#fff;font-family:var(--mono);font-size:13px}

    .notice{margin-top:10px;padding:10px;border:1px dashed #ffd48a;background:#fff8e1;border-radius:12px;color:#634300}

    .hide{display:none !important}
    footer{color:var(--muted);font-size:12px;text-align:center;margin:18px 0 8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand-mark" aria-hidden="true"><span class="logo-square" role="img" aria-label="Logo"></span></div>
      <h1 id="resto-nome">Restaurante (CONFIG)</h1>
      <p id="resto-sub">Seu prato, seu jeito. Monte agora!</p>
      <div class="pill">‚è∞ Pedidos at√© <strong id="cutoff-label">14:30</strong></div>
    </header>

    <div class="grid">
      <section class="card" id="builder-default">
        <h2>Monte sua marmita üçΩÔ∏è (padr√£o)</h2>
        <section style="margin-bottom:10px">
          <h3 style="margin:0 0 8px">üì¶ Tamanho</h3>
          <fieldset class="list" id="sec-tamanho"></fieldset>
        </section>
        <section style="margin-bottom:10px">
          <h3 style="margin:0 0 8px">ü•© Prote√≠na</h3>
          <div class="chips" id="sec-proteina"></div>
        </section>
        <section style="margin-bottom:10px">
          <h3 style="margin:0 0 8px">ü•ó Acompanhamentos & Saladas <small id="acc-hint" class="hint"></small></h3>
          <div class="chips" id="sec-acc"></div>
        </section>
        <section class="row" style="margin-bottom:10px">
          <div>
            <h3 style="margin:0 0 8px">‚ûï Adicionais (R$ 2,00)</h3>
            <div class="chips" id="sec-add2"></div>
          </div>
          <div>
            <h3 style="margin:0 0 8px">üçñ Carnes extras (R$ 8,00)</h3>
            <div class="chips" id="sec-add8"></div>
          </div>
        </section>
        <section style="margin-bottom:10px">
          <h3 style="margin:0 0 8px">ü•§ Bebidas</h3>
          <fieldset class="list" id="sec-bebidas"></fieldset>
        </section>
        <section style="margin-bottom:10px">
          <h3 style="margin:0 0 8px">üìù Observa√ß√µes do item</h3>
          <textarea id="obs-item" placeholder="Prefer√™ncias para ESTA marmita"></textarea>
        </section>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add">üõí Adicionar ao carrinho</button>
          <button class="btn btn-ghost" id="btn-reset">üßπ Limpar sele√ß√£o</button>
        </div>
      </section>

      <section class="card hide" id="builder-ios">
        <h2>üçé iPhone ‚Äî preenchimento r√°pido</h2>
        <p class="hint">Toque em uma op√ß√£o pronta ou preencha manualmente. Campos em branco s√£o opcionais.</p>

        <div class="row" id="ios-presets">
          <div class="card" style="border-style:dashed">
            <h3 style="margin:0 0 8px">‚≠ê Op√ß√£o 1</h3>
            <div class="hint" id="ios-op1-desc"></div>
            <div class="actions"><button class="btn btn-primary" id="btn-op1">Usar Op√ß√£o 1</button></div>
          </div>
          <div class="card" style="border-style:dashed">
            <h3 style="margin:0 0 8px">‚≠ê Op√ß√£o 2</h3>
            <div class="hint" id="ios-op2-desc"></div>
            <div class="actions"><button class="btn btn-primary" id="btn-op2">Usar Op√ß√£o 2</button></div>
          </div>
        </div>

        <p class="hint" style="margin-top:8px">Ou personalize digitando abaixo (separe por v√≠rgulas):</p>
        <div class="row">
          <div>
            <label for="ios-tamanho">üì¶ Tamanho (P ou G)</label>
            <input id="ios-tamanho" type="text" inputmode="text" placeholder="P ou G">
          </div>
          <div>
            <label for="ios-proteina">ü•© Prote√≠na</label>
            <input id="ios-proteina" type="text" inputmode="text" placeholder="Ex.: Lombo, Carne cozida, Strogonoff">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="ios-acc">ü•ó Acompanhamentos & Saladas</label>
            <input id="ios-acc" type="text" inputmode="text" placeholder="Ex.: Arroz, Feij√£o, Salada verde">
          </div>
          <div>
            <label for="ios-add2">‚ûï Adicionais (+R$2 cada)</label>
            <input id="ios-add2" type="text" inputmode="text" placeholder="Ex.: Arroz separado, Molho extra">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="ios-add8">üçñ Carnes extras (+R$8 cada)</label>
            <input id="ios-add8" type="text" inputmode="text" placeholder="Ex.: Por√ß√£o extra de strogonoff">
          </div>
          <div>
            <label for="ios-bebidas">ü•§ Bebidas</label>
            <input id="ios-bebidas" type="text" inputmode="text" placeholder="Ex.: Coca 2L, Sprite lata">
          </div>
        </div>
        <div>
          <label for="ios-obs">üìù Observa√ß√µes do item</label>
          <input id="ios-obs" type="text" inputmode="text" placeholder="Ex.: Pouco sal, sem pimenta">
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-ios">üõí Adicionar ao carrinho</button>
          <button class="btn btn-ghost" id="btn-reset-ios">üßπ Limpar campos</button>
        </div>
      </section>

      <aside class="card cart" id="cart">
        <h2>üß∫ Seu carrinho</h2>
        <div class="cart-list" id="cart-list"></div>
        <div class="total">
          <strong>Total</strong>
          <div id="cart-total">R$ 0,00</div>
        </div>
        <div class="actions">
          <button class="btn btn-danger" id="btn-clear-cart">üóëÔ∏è Esvaziar carrinho</button>
        </div>
      </aside>
    </div>

    <section class="card" id="checkout" style="margin-top:12px">
      <h2>üßæ Checkout</h2>
      <div class="row">
        <div>
          <label for="nome">üôç Nome</label>
          <input id="nome" type="text" placeholder="Seu nome">
        </div>
        <div>
          <label for="endereco">üìç Endere√ßo</label>
          <input id="endereco" type="text" placeholder="Rua, n√∫mero, complemento" autocomplete="street-address">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="bairro">üèòÔ∏è Bairro</label>
          <input id="bairro" type="text" placeholder="Ex.: Centro">
        </div>
        <div>
          <label for="referencia">üìå Ponto de refer√™ncia</label>
          <input id="referencia" type="text" placeholder="Ex.: Pr√≥ximo √† padaria Y">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="hora">‚è∞ Hor√°rio</label>
          <input id="hora" type="time">
        </div>
        <div>
          <label for="pagamento">üí≥ Pagamento</label>
          <select id="pagamento">
            <option value="">Selecione‚Ä¶</option>
            <option>PIX</option>
            <option>Dinheiro</option>
            <option>Cart√£o de d√©bito</option>
            <option>Cart√£o de cr√©dito</option>
          </select>
        </div>
      </div>

      <div id="troco-wrap" style="display:none;margin-top:10px">
        <label for="troco">üíµ Troco para (R$)</label>
        <input id="troco" type="number" step="1" inputmode="numeric" placeholder="Ex.: 100">
        <p class="hint">O sistema calcula o troco automaticamente.</p>
      </div>

      <div class="notice" id="taxa-notice">
        <strong>Aten√ß√£o üöö:</strong> no momento da finaliza√ß√£o no WhatsApp, ser√° calculada a <u>taxa de entrega</u> em cima do valor total.
      </div>

      <h3 style="margin:12px 0 8px">Pr√©via da mensagem</h3>
      <div id="preview" class="preview"></div>
      <div class="actions">
        <button class="btn" id="btn-copy">üìã Copiar mensagem</button>
        <button class="btn btn-primary" id="btn-wa">üí¨ Enviar pelo WhatsApp</button>
      </div>
      <div id="fb" class="hint" aria-live="polite"></div>
    </section>

    <footer>
      <div class="brand-mark" aria-hidden="true" style="justify-content:center; margin-bottom:6px"><span class="logo-square" role="img" aria-label="Logo"></span></div>
      <small id="wa-number" data-phone="5531992034948">MARMITA.ONE ‚Ä¢ v0.3.1 ‚Ä¢ uso local/offline</small>
    </footer>

    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand-mark"><span class="logo-square" role="img" aria-label="Logo"></span><div class="hint">Compatibilidade iOS/Android</div></div>
        <div class="actions">
          <button id="btn-mode-ios" class="btn btn-promo">üçé Estou usando iPhone</button>
          <button id="btn-mode-default" class="btn">ü§ñ Modo padr√£o (Android/PC)</button>
        </div>
      </div>
    </div>
  </div>

<script>
// Registro do Service Worker para PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('service-worker.js')
      .then(function(registration) {
        console.log('ServiceWorker registrado com sucesso:', registration);
      })
      .catch(function(error) {
        console.log('Falha ao registrar o ServiceWorker:', error);
      });
  });
}
const CONFIG = {
  identidade: { nome:"Restaurante da C√©lia", sub:"Seu prato, seu jeito. Monte agora!", cutoff:"14:30" },
  regras: { limiteAcompanhamentos: null, obrigatorios:["tamanho","proteina"], precoAdicional:2, precoCarneExtra:8 },

    <header>
      <div class="brand-mark" aria-hidden="true"><span class="logo-square" role="img" aria-label="Logo"></span></div>
      <h1 id="resto-nome">Restaurante (CONFIG)</h1>
      <p id="resto-sub">Seu prato, seu jeito. Monte agora!</p>
      <div class="pill">‚è∞ Pedidos at√© <strong id="cutoff-label">14:30</strong></div>
    </header>

    <!-- Tela inicial de escolha de fluxo -->
    <section class="card" id="start-menu">
      <h2>Como deseja montar sua marmita?</h2>
      <div class="actions" style="margin-top:18px">
        <button class="btn btn-primary" id="btn-flow-custom">Quero montar minha marmita</button>
        <button class="btn btn-promo" id="btn-flow-preset">Escolher op√ß√µes prontas</button>
      </div>
    </section>

    <div id="main-flows" class="hide">
      <div class="grid">
        <section class="card" id="builder-default">
          ...existing code...
        </section>
        <section class="card hide" id="builder-ios">
          ...existing code...
        </section>
        <aside class="card cart" id="cart">
          ...existing code...
        </aside>
      </div>
      <section class="card" id="checkout" style="margin-top:12px">
        ...existing code...
      </section>
      <footer>
        ...existing code...
      </footer>
      <div class="topbar">
        ...existing code...
      </div>
    </div>
    { nome:"Suco Kapo", valor:3.50, aliases:["suco kapo","kapo","suco de caixinha","suco caixinha","caixinha"] },
    { nome:"Suco Lata", valor:6.00, aliases:["suco","suco lata"] }
  ],
  presetsIOS: {
    opcao1: {
      label:"Op√ß√£o 1",
      tamanho:"G",
      proteina:"Bife de Frango",
      acc:"Arroz, Feij√£o, Angu, Quiabo, Almeir√£o Refogado, Saladas",
      add2:"",
      add8:"",
      bebidas:"",
      obs:""
    },
    opcao2: {
      label:"Op√ß√£o 2",
      tamanho:"G",
      proteina:"Carne Cozida",
      acc:"Arroz, Feij√£o, Farofa, Batata Ensopada, Saladas",
      add2:"",
      add8:"",
      bebidas:"",
      obs:""
    }
  },
  msg: {
    titulo: "üç± *Pedido de Marmitas*",
    agradecimento: "Obrigada! üôå",
    notaPIX: "Produ√ß√£o inicia ap√≥s envio do comprovante PIX.",
    taxaAviso: "Taxa de entrega ser√° calculada no WhatsApp conforme a regi√£o."
  }
};

const NL="\n", BULLET="‚Ä¢";
const byId = id => document.getElementById(id);
const fmt = v => Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const norm = s => (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
const splitList = s => norm(s).split(/[,;/]+/).map(x=>x.trim()).filter(Boolean);

const STORAGE_MODE_KEY = "marmitaone_mode_031";
const STORAGE_CART_KEY = "marmitaone_cart_031";
let MODE = localStorage.getItem(STORAGE_MODE_KEY) || "default";
let CART = [];

function renderIdentidade(){
  byId("resto-nome").textContent = CONFIG.identidade.nome;
  byId("resto-sub").textContent  = CONFIG.identidade.sub;
  byId("cutoff-label").textContent = CONFIG.identidade.cutoff;
}
function renderTamanhos(){
  const box = byId("sec-tamanho"); box.innerHTML = "";
  CONFIG.tamanhos.forEach(t=>{
    const id = `tam-${t.id}`;
    const row = document.createElement("div"); row.className="item";
    const lab = document.createElement("label"); lab.htmlFor=id; lab.textContent=t.nome;
    const price = document.createElement("span"); price.className="price"; price.textContent = fmt(t.valor);
    const input = document.createElement("input"); input.type="radio"; input.name="tamanho"; input.id=id; input.value=t.nome; input.dataset.price=t.valor;
    row.append(lab,price,input); box.append(row);
  });
}
function renderProteinas(){
  const box = byId("sec-proteina"); box.innerHTML = "";
  CONFIG.proteinas.forEach(p=>{
    const lbl = document.createElement("label"); lbl.className="chip";
    const inp = document.createElement("input"); inp.type="radio"; inp.name="proteina"; inp.value=p.nome;
    lbl.append(inp, document.createTextNode(p.nome)); box.append(lbl);
  });
}
function renderAcompanhamentos(){
  const box = byId("sec-acc"); box.innerHTML = "";
  CONFIG.acompanhamentos.forEach(n=>{
    const lbl=document.createElement("label"); lbl.className="chip";
    const inp=document.createElement("input"); inp.type="checkbox"; inp.value=n;
    lbl.append(inp, document.createTextNode(n)); box.append(lbl);
  });
  const hint = byId("acc-hint");
  hint.textContent = CONFIG.regras.limiteAcompanhamentos ? `(at√© ${CONFIG.regras.limiteAcompanhamentos})` : `(sem limite)`;
}
function renderAdicionais(){
  const b2 = byId("sec-add2"); b2.innerHTML = "";
  CONFIG.adicionais2.forEach(n=>{
    const lbl=document.createElement("label"); lbl.className="chip";
    const inp=document.createElement("input"); inp.type="checkbox"; inp.value=n; inp.dataset.extra=CONFIG.regras.precoAdicional;
    lbl.append(inp, document.createTextNode(`${n} (+${fmt(CONFIG.regras.precoAdicional)})`)); b2.append(lbl);
  });
  const b8 = byId("sec-add8"); b8.innerHTML = "";
  CONFIG.carnesExtras8.forEach(n=>{
    const lbl=document.createElement("label"); lbl.className="chip";
    const inp=document.createElement("input"); inp.type="checkbox"; inp.value=n; inp.dataset.extra=CONFIG.regras.precoCarneExtra;
    lbl.append(inp, document.createTextNode(`${n} (+${fmt(CONFIG.regras.precoCarneExtra)})`)); b8.append(lbl);
  });
}
function renderBebidas(){
  const box = byId("sec-bebidas"); box.innerHTML = "";
  CONFIG.bebidas.forEach((b,idx)=>{
    const id = `beb-${idx}`;
    const row = document.createElement("div"); row.className="item";
    const lab = document.createElement("label"); lab.htmlFor=id; lab.textContent=b.nome;
    const price = document.createElement("span"); price.className="price"; price.textContent = fmt(b.valor);
    const input = document.createElement("input"); input.type="checkbox"; input.id=id; input.value=b.nome; input.dataset.price=b.valor;
    row.append(lab,price,input); box.append(row);
  });
}

function getChecked(sel){ return Array.from(document.querySelectorAll(`${sel}:checked`)) }
function getRadio(name){ return document.querySelector(`input[name="${name}"]:checked`) }

function getItemAtualDefault(){
  const tam = getRadio("tamanho");
  const prot = getRadio("proteina");
  const acc = getChecked('#sec-acc input[type="checkbox"]').map(el=>el.value);
  const add2 = getChecked('#sec-add2 input[type="checkbox"]').map(el=>el.value);
  const add8 = getChecked('#sec-add8 input[type="checkbox"]').map(el=>el.value);
  const beb  = getChecked('#sec-bebidas input[type="checkbox"]').map(el=>({nome:el.value, preco:Number(el.dataset.price||0)}));
  const obs  = byId("obs-item").value.trim();

  const precoTamanho = tam ? Number(tam.dataset.price||0) : 0;
  const totalAdd2 = add2.length * CONFIG.regras.precoAdicional;
  const totalAdd8 = add8.length * CONFIG.regras.precoCarneExtra;
  const totalBebidas = beb.reduce((s,b)=>s + (b.preco||0), 0);

  const total = precoTamanho + totalAdd2 + totalAdd8 + totalBebidas;

  return { tamanho: tam?tam.value:"", proteina: prot?prot.value:"", acompanhamentos:acc, adicionais2:add2, carnes8:add8, bebidas:beb, obs,
           totais:{precoTamanho, totalAdd2, totalAdd8, totalBebidas, total}};
}

function matchFromListTerm(list, term){
  const t = norm(term);
  if(!t) return null;
  for(const item of list){
    const name = typeof item === "string" ? item : item.nome;
    const aliases = (typeof item === "string") ? [] : (item.aliases||[]);
    const candidates = [name, ...aliases].map(norm);
    if(candidates.some(c => c === t || c.includes(t) || t.includes(c))){
      return item;
    }
  }
  for(const item of list){
    const name = typeof item === "string" ? item : item.nome;
    if(norm(name).includes(t)) return item;
  }
  return null;
}

function getItemAtualIOS(){
  const tTam = byId("ios-tamanho").value;
  const tProt= byId("ios-proteina").value;
  const tAcc = byId("ios-acc").value;
  const tAdd2= byId("ios-add2").value;
  const tAdd8= byId("ios-add8").value;
  const tBeb = byId("ios-bebidas").value;
  const obs  = byId("ios-obs").value.trim();

  let tamanhoNome = "";
  let precoTamanho = 0;
  if(tTam){
    const term = norm(tTam);
    let found = null;
    if(term === "p") found = CONFIG.tamanhos.find(x=>x.id==="S");
    if(term === "g") found = CONFIG.tamanhos.find(x=>x.id==="L");
    if(!found) found = matchFromListTerm(CONFIG.tamanhos, term);
    if(found){ tamanhoNome = found.nome; precoTamanho = Number(found.valor||0); }
  }

  let proteinaNome = "";
  if(tProt){
    const m = matchFromListTerm(CONFIG.proteinas, tProt);
    proteinaNome = m? (m.nome || m) : tProt.trim();
  }

  const acc = splitList(tAcc).map(term=>{
    const m = matchFromListTerm(CONFIG.acompanhamentos, term);
    return m? (m.nome || m) : term;
  });

  const add2 = splitList(tAdd2).map(term=>{
    const m = matchFromListTerm(CONFIG.adicionais2, term);
    return m? (m.nome || m) : term;
  });

  const add8 = splitList(tAdd8).map(term=>{
    const m = matchFromListTerm(CONFIG.carnesExtras8, term);
    return m? (m.nome || m) : term;
  });

  const bebidas = splitList(tBeb).map(term=>{
    const m = matchFromListTerm(CONFIG.bebidas, term);
    if(m && m.nome){ return {nome:m.nome, preco:Number(m.valor||0)} }
    return {nome:term, preco:0};
  });

  const totalAdd2 = add2.length * CONFIG.regras.precoAdicional;
  const totalAdd8 = add8.length * CONFIG.regras.precoCarneExtra;
  const totalBebidas = bebidas.reduce((s,b)=> s + (b.preco||0), 0);
  const total = precoTamanho + totalAdd2 + totalAdd8 + totalBebidas;

  return { tamanho:tamanhoNome, proteina:proteinaNome, acompanhamentos:acc, adicionais2:add2, carnes8:add8, bebidas, obs,
           totais:{precoTamanho, totalAdd2, totalAdd8, totalBebidas, total} };
}

function validarItem(item){
  const req = CONFIG.regras.obrigatorios;
  const msgs = [];
  if(req.includes("tamanho") && !item.tamanho) msgs.push("Informe o tamanho (P ou G).");
  if(req.includes("proteina") && !item.proteina) msgs.push("Informe a prote√≠na.");
  if(CONFIG.regras.limiteAcompanhamentos){
    const L = CONFIG.regras.limiteAcompanhamentos;
    if(item.acompanhamentos.length > L) msgs.push(`M√°ximo de ${L} acompanhamentos.`);
  }
  return { ok: msgs.length===0, msgs };
}

function miniItem(it){
  const parts = [];
  parts.push(`Tamanho: ${it.tamanho||"-"}`);
  parts.push(`Prote√≠na: ${it.proteina||"-"}`);
  if(it.acompanhamentos?.length) parts.push(`Acc: ${it.acompanhamentos.join(', ')}`);
  if(it.adicionais2?.length) parts.push(`+R$2: ${it.adicionais2.join(', ')}`);
  if(it.carnes8?.length) parts.push(`+R$8: ${it.carnes8.join(', ')}`);
  if(it.bebidas?.length) parts.push(`Bebidas: ${it.bebidas.map(b=>b.nome).join(', ')}`);
  if(it.obs) parts.push(`Obs.: ${it.obs}`);
  return parts.join("\n");
}

function saveCart(){ try{ localStorage.setItem(STORAGE_CART_KEY, JSON.stringify(CART)); }catch(e){} }
function loadCart(){ try{ CART = JSON.parse(localStorage.getItem(STORAGE_CART_KEY)||"[]"); }catch(e){ CART=[] } }
function cartTotal(){ return CART.reduce((s,x)=> s + Number(x.total||0), 0) }

function addItemToCart(){
  const item = MODE==="ios" ? getItemAtualIOS() : getItemAtualDefault();
  const v = validarItem(item);
  if(!v.ok){ setFB(v.msgs.join(" "), "err"); return; }
  const id = Date.now() + Math.floor(Math.random()*1000);
  CART.push({ id, item, total:item.totais.total, mini: miniItem(item) });
  saveCart(); renderCart(); clearBuilder(); renderPreview(); setFB("Marmita adicionada ao carrinho.", "ok");
}

function renderCart(){
  const list = byId("cart-list"); list.innerHTML="";
  CART.forEach(entry=>{
    const el = document.createElement("div"); el.className="cart-item";
    const h3 = document.createElement("h3"); h3.textContent = `Marmita #${entry.id}`;
    const mini = document.createElement("div"); mini.className="cart-mini"; mini.textContent = entry.mini;
    const total = document.createElement("div"); total.style.marginTop="6px"; total.innerHTML = `<strong>${fmt(entry.total)}</strong>`;
    const rowBtn = document.createElement("div"); rowBtn.className="actions";
    const btnRem = document.createElement("button"); btnRem.className="btn btn-danger"; btnRem.textContent="Remover";
    btnRem.addEventListener("click", ()=>{ CART = CART.filter(x=>x.id!==entry.id); saveCart(); renderCart(); renderPreview(); });
    rowBtn.append(btnRem);
    el.append(h3, mini, total, rowBtn); list.append(el);
  });
  byId("cart-total").textContent = fmt(cartTotal());
}

function clearBuilder(){
  document.querySelectorAll('#builder-default input[type="radio"],#builder-default input[type="checkbox"]').forEach(i=>i.checked=false);
  byId("obs-item").value="";
  ["ios-tamanho","ios-proteina","ios-acc","ios-add2","ios-add8","ios-bebidas","ios-obs"].forEach(id=>byId(id).value="");
}

function coletarCheckout(){
  const nome = byId("nome").value.trim();
  const endereco = byId("endereco").value.trim();
  const bairro = byId("bairro").value.trim();
  const referencia = byId("referencia").value.trim();
  const hora = byId("hora").value;
  const pagamento = byId("pagamento").value;
  const trocoPara = byId("troco").value;
  let troco = null;
  if(pagamento === "Dinheiro" && trocoPara){
    const x = Number(String(trocoPara).replace(",","."));
    if(!Number.isNaN(x)) troco = Math.max(0, x - cartTotal());
  }
  return { nome, endereco, bairro, referencia, hora, pagamento, trocoPara, troco };
}

function validarCheckout(d){
  const msgs = [];
  if(!CART.length) msgs.push("Adicione pelo menos 1 item ao carrinho.");
  if(!d.endereco) msgs.push("Informe o endere√ßo para entrega.");
  if(!d.pagamento) msgs.push("Escolha a forma de pagamento.");
  return { ok: msgs.length===0, msgs };
}

function montarMensagem(){
  const d = coletarCheckout();
  const v = validarCheckout(d);
  if(!v.ok){ setFB(v.msgs.join(" "), "err"); return ""; }

  const linhas = [];
  linhas.push(CONFIG.msg.titulo);
  linhas.push(`${BULLET} ${CONFIG.identidade.nome}`);
  linhas.push("");

  CART.forEach((e,idx)=>{
    const it = e.item;
    linhas.push(`Marmita #${idx+1}`);
    if(it.tamanho) linhas.push(`${BULLET} Tamanho: ${it.tamanho}`);
    if(it.proteina) linhas.push(`${BULLET} Prote√≠na: ${it.proteina}`);
    if(it.acompanhamentos?.length) linhas.push(`${BULLET} Acompanhamentos: ${it.acompanhamentos.join(', ')}`);
    if(it.adicionais2?.length) linhas.push(`${BULLET} Adicionais (+${fmt(CONFIG.regras.precoAdicional)}): ${it.adicionais2.join(', ')}`);
    if(it.carnes8?.length) linhas.push(`${BULLET} Carnes extras (+${fmt(CONFIG.regras.precoCarneExtra)}): ${it.carnes8.join(', ')}`);
    if(it.bebidas?.length) linhas.push(`${BULLET} Bebidas: ${it.bebidas.map(b=>`${b.nome}${b.preco?` (${fmt(b.preco)})`:''}`).join(', ')}`);
    if(it.obs) linhas.push(`${BULLET} Obs.: ${it.obs}`);
    linhas.push(`Valor: ${fmt(e.totais?.total ?? e.total ?? 0)}`);
    linhas.push("");
  });

  linhas.push(`Total dos itens: *${fmt(cartTotal())}*`);
  linhas.push(CONFIG.msg.taxaAviso);
  linhas.push("");

  linhas.push(`üìç *Entrega:*`);
  if(d.nome) linhas.push(`${BULLET} Nome: ${d.nome}`);
  const enderecoFull = [d.endereco, d.bairro?`‚Äì ${d.bairro}`:"", d.referencia?`(Ref.: ${d.referencia})`:""].join(" ").replace(/\s+/g," ").trim();
  if(enderecoFull) linhas.push(`${BULLET} Endere√ßo: ${enderecoFull}`);
  if(d.hora) linhas.push(`${BULLET} Hor√°rio: ${d.hora}`);
  if(d.pagamento) linhas.push(`${BULLET} Pagamento: ${d.pagamento}`);
  if(d.pagamento === "PIX") linhas.push(`${BULLET} Observa√ß√£o: ${CONFIG.msg.notaPIX}`);
  if(d.pagamento === "Dinheiro" && d.troco !== null){
    linhas.push(`${BULLET} Troco para: ${fmt(Number(d.trocoPara))}`);
    linhas.push(`${BULLET} Enviar troco: ${fmt(d.troco)}`);
  }

  linhas.push("");
  linhas.push(`Pedidos at√© ${CONFIG.identidade.cutoff}`);
  linhas.push(CONFIG.msg.agradecimento);

  return linhas.join(NL).replace(/\n{3,}/g,"\n\n").trim();
}

function renderPreview(){ byId("preview").textContent = montarMensagem() || ""; }
function setFB(txt,t=""){ byId("fb").innerHTML = `<span class="${t}">${txt}</span>` }

function abrirWhatsApp(){
  const msg = montarMensagem(); if(!msg) return;
  const base = "https://wa.me/";
  const phone = byId("wa-number").dataset.phone || "";
  const url = (phone? base+phone+"?text=" : base+"?text=") + encodeURIComponent(msg);
  window.open(url, "_blank", "noopener");
  setFB("Abrindo WhatsApp‚Ä¶", "ok");
}

async function copiarMensagem(){
  const msg = montarMensagem(); if(!msg){ setFB("Nada para copiar.", "warn"); return; }
  try{ await navigator.clipboard.writeText(msg); setFB("Mensagem copiada.", "ok"); }
  catch{
    const ta=document.createElement("textarea"); ta.value=msg; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
    setFB("Mensagem copiada (compatibilidade).", "ok");
  }
}

function setMode(mode){
  MODE = mode;
  localStorage.setItem(STORAGE_MODE_KEY, MODE);
  byId("builder-default").classList.toggle("hide", MODE==="ios");
  byId("builder-ios").classList.toggle("hide", MODE!=="ios");
  setTimeout(()=>{ (MODE==="ios" ? byId("builder-ios") : byId("builder-default")).scrollIntoView({behavior:"smooth", block:"start"}); }, 50);
}

function onPagamento(){ byId("troco-wrap").style.display = (byId("pagamento").value === "Dinheiro") ? "block" : "none"; renderPreview(); }

function applyPreset(which){
  const p = CONFIG.presetsIOS[which]; if(!p) return;
  byId("ios-tamanho").value = p.tamanho || "";
  byId("ios-proteina").value = p.proteina || "";
  byId("ios-acc").value = p.acc || "";
  byId("ios-add2").value = p.add2 || "";
  byId("ios-add8").value = p.add8 || "";
  byId("ios-bebidas").value = p.bebidas || "";
  byId("ios-obs").value = p.obs || "";
  renderPreview();
}

function renderPresetDescriptions(){
  const p1 = CONFIG.presetsIOS.opcao1, p2 = CONFIG.presetsIOS.opcao2;
  if(p1){ byId("ios-op1-desc").textContent = `${p1.tamanho || ''} ¬∑ ${p1.proteina || ''} ¬∑ ${p1.acc || ''}`.replace(/\s¬∑\s$/,''); }
  if(p2){ byId("ios-op2-desc").textContent = `${p2.tamanho || ''} ¬∑ ${p2.proteina || ''} ¬∑ ${p2.acc || ''}`.replace(/\s¬∑\s$/,''); }
}

function init(){
  renderIdentidade();
  renderTamanhos(); renderProteinas(); renderAcompanhamentos(); renderAdicionais(); renderBebidas();
  renderPresetDescriptions();
  loadCart(); renderCart();

  document.getElementById("btn-add").addEventListener("click", addItemToCart);
  document.getElementById("btn-reset").addEventListener("click", clearBuilder);
  document.getElementById("btn-add-ios").addEventListener("click", addItemToCart);
  document.getElementById("btn-reset-ios").addEventListener("click", clearBuilder);
  document.getElementById("btn-clear-cart").addEventListener("click", ()=>{ CART=[]; saveCart(); renderCart(); renderPreview(); });
  document.getElementById("btn-copy").addEventListener("click", copiarMensagem);
  document.getElementById("btn-wa").addEventListener("click", abrirWhatsApp);
  document.getElementById("pagamento").addEventListener("change", onPagamento);

  document.getElementById("btn-mode-ios").addEventListener("click", ()=>setMode("ios"));
  document.getElementById("btn-mode-default").addEventListener("click", ()=>setMode("default"));

  document.getElementById("btn-op1").addEventListener("click", ()=>applyPreset('opcao1'));
  document.getElementById("btn-op2").addEventListener("click", ()=>applyPreset('opcao2'));

  document.addEventListener("input", renderPreview);
  document.addEventListener("change", renderPreview);

  setMode(MODE);
  renderPreview();
}

document.addEventListener("DOMContentLoaded", function() {
  init();
  // Fluxo de tela inicial
  const startMenu = document.getElementById("start-menu");
  const mainFlows = document.getElementById("main-flows");
  const btnCustom = document.getElementById("btn-flow-custom");
  const btnPreset = document.getElementById("btn-flow-preset");
  const builderDefault = document.getElementById("builder-default");
  const builderIOS = document.getElementById("builder-ios");

  function showFlow(flow) {
    startMenu.classList.add("hide");
    mainFlows.classList.remove("hide");
    if (flow === "custom") {
      builderDefault.classList.remove("hide");
      builderIOS.classList.add("hide");
      setMode("default");
    } else {
      builderDefault.classList.add("hide");
      builderIOS.classList.remove("hide");
      setMode("ios");
    }
    setTimeout(() => {
      mainFlows.scrollIntoView({behavior: "smooth", block: "start"});
    }, 50);
  }
  btnCustom.addEventListener("click", () => showFlow("custom"));
  btnPreset.addEventListener("click", () => showFlow("preset"));
});
document.addEventListener("DOMContentLoaded", function() {
  init();
  // Fluxo de tela inicial
  const startMenu = document.getElementById("start-menu");
  const mainFlows = document.getElementById("main-flows");
  const btnCustom = document.getElementById("btn-flow-custom");
  const btnPreset = document.getElementById("btn-flow-preset");
  const builderDefault = document.getElementById("builder-default");
  const builderIOS = document.getElementById("builder-ios");

  function showFlow(flow) {
    startMenu.classList.add("hide");
    mainFlows.classList.remove("hide");
    if (flow === "custom") {
      builderDefault.classList.remove("hide");
      builderIOS.classList.add("hide");
      setMode("default");
    } else {
      builderDefault.classList.add("hide");
      builderIOS.classList.remove("hide");
      setMode("ios");
    }
    setTimeout(() => {
      mainFlows.scrollIntoView({behavior: "smooth", block: "start"});
    }, 50);
  }
  btnCustom.addEventListener("click", () => showFlow("custom"));
  btnPreset.addEventListener("click", () => showFlow("preset"));
});
</script>
</body>
</html>
